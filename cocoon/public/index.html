<html>
    <head>
        <title>client</title>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="/primus/primus.js"></script>
        <script>
            var state = {
                crew: []
            };

            const CrewList = {
                view: function() {
                    const crewMen = state.crew.map(function(crewMan) {
                        return m('tr', [
                            m('td', { style: 'border: solid 1px red;' }, crewMan.id),
                            m('td', { style: 'border: solid 1px red;' }, crewMan.ship.name),
                            m('td', { style: 'border: solid 1px red;' }, crewMan.name)
                        ]);
                    });

                    crewMen.unshift(m('tr', [
                        m('th', { style: 'border: solid 1px blue;' }, 'id'),
                        m('th', { style: 'border: solid 1px blue;' }, 'ship'),
                        m('th', { style: 'border: solid 1px blue;' }, 'name')
                    ]));

                    return m('div', [
                        m('h1', 'crew'),
                        m('table', { style: '' }, crewMen)
                    ]);
                }
            };

            const App = {
                view: function() {

                    return m('div', [
                        m(CrewList)
                    ]);
                }
            };

            m.request({
                method: "POST",
                url: "/login",
                data: {username: "bob", password: "banana"}
            })
            .then(function(result) {
                const token = result.token;
                console.log(Primus, token)
                const primus = new Primus('?token=' + token, {});
                primus.on('authorized', function() {
                    console.log('Authorized');
                    primus.emit('subscription', {id: 'abc123', payload: '{ ships { id, speed, sailCooldown, size , owner, x, y, route { x, y}, user { username } }, myScore { username, ships }, crew { id, name, ship { id, name } } }' });
                    primus.on('subscriptionResponse', function(message) {
                        state = message.payload
                        console.log('SUBSCRIPTION', message);
                        m.redraw();
                    });
                    primus.emit('intent', {type: 'tick', payload: 1});
                });
            })
        </script>
    </head>
    <body>
        <script>
            m.mount(document.body, App)
        </script>
    </body>
</html>
