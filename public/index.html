
<html>
    <head>
        <title>solo</title>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="highland.min.js"></script>
        <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
    </head>
<body>
    <a-scene embedded id='scene'>
      <a-box class="countBox" position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
    <div id='root' style='position: absolute; top: 0;'></div>
    <script>
        var _ = highland;

        var Hello = {
            view: function(vnode) {
                return m("div", { style: ''}, [
                    m("h1", {class: "title"}, "My first app"),
                    m("button", {
                        onclick: function() {
                            vnode.attrs.pushFact({type: 'RAISE_COUNTER'});
                        }
                    }, '+'),
                    m("button", {
                        onclick: function() {
                            vnode.attrs.pushFact({type: 'LOWER_COUNTER'});
                        }
                    }, '-'),
                    m("span", vnode.attrs.name + ' (' + vnode.attrs.state.counter + ')')
                ]);
            }
        };

        var facts = [];
        var state = {};

        var pipelines = {};

        pipelines.counter = function() {
            return _.pipeline(
                _.reduce(0, function(count, entry) {
                    if (entry.type && entry.type === 'RAISE_COUNTER') {
                        return count + 1;
                    }
                    else if (entry.type && entry.type === 'LOWER_COUNTER') {
                        return count - 1;
                    }
                    return count
                }),
                _.doto(function(count) {
                    var sceneEl = document.getElementById('scene');
                    sceneEl.querySelectorAll('.countBox').forEach(function(element) {
                        element.parentNode.removeChild(element);
                    });

                    for (var i = 0; i < count; i++) {
                        var el = document.createElement('a-box');
                        el.setAttribute('class', 'countBox');
                        el.setAttribute('position', i+' 0 0');
                        el.setAttribute('rotation', '0 0 0');
                        el.setAttribute('color', '#4CC3D9');
                        sceneEl.appendChild(el);
                    }
                }),
                _.map(function(count) {
                    if (count > 0) {
                        return '+' + count;
                    }

                    return count + '';
                })
            )
        };

        var recalculateState = function() {
            Object.keys(pipelines).forEach(function(pipelineKey) {
                _(facts)
                    .pipe(pipelines[pipelineKey]())
                    .pull(function (err, result) {
                        state[pipelineKey] = result;
                    });
            });
        }

        recalculateState();

        var Connect = function(component) {

            return {
                view: function(vnode) {
                    var attrs = object2 = Object.assign({}, vnode.attrs);
                    attrs.pushFact = function(fact) {
                        facts.push(JSON.parse(JSON.stringify(fact)));
                        recalculateState();
                    };

                    attrs.state = state;

                    return m(component, attrs, vnode.children);
                }
            };
        };

        var HelloContainer = Connect(Hello);

        var App = {
            view: function() {
                return m("div", [
                    m(HelloContainer, {name: 'nice'})
                ])
            }
        };

        m.mount(document.getElementById('root'), App);
    </script>
</body>
</html>
